---
layout:     post
title:      "ReentrantReadWriteLock Source"
subtitle:   "ReentrantReadWriteLock æºç åˆ†æ"
date:       2019-06-30 16:00:00
author:     "Mickey"
header-img: "img/post-bg-js-module.jpg"
tags:
    - java
---

[ReentrantReadWriteLock æºç åˆ†æ(åŸºäºJava 8)](https://www.jianshu.com/p/6923c126e762)

ğŸ‘†è¿™ç¯‡ blog è®²è§£çš„éå¸¸æ¸…æ¥šï¼Œæ¨èç»™å¤§å®¶ï¼Œè¿™é‡Œæˆ‘è‡ªå·±è®°å½•ä¸€ä¸‹ä¸ªäººçš„æ„Ÿæ‚Ÿ

1. ReentrantReadWriteLock åˆ›å»ºäº† ReadLock ç±»å’Œ WriteLock ç±»
2. è¯»é”å’Œå†™é”æ˜¯äº’æ–¥çš„ï¼Œå†™é”ä¸ä¼šæŠ¢å è¯»é”
3. å½“çº¿ç¨‹è·å–å†™é”çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥ç»§ç»­è·å–è¯»é”çš„ï¼Œè¿™æ˜¯é”é™çº§ï¼Œåä¹‹åˆ™ä¸è¡Œï¼Œä¼šé€ æˆæ­»é”
4. çº¿ç¨‹å¦‚æœæ²¡æœ‰ç”³è¯·åˆ°è¯»é”å’Œå†™é”ï¼Œä¼šæŒ‚èµ·ï¼Œçº¿ç¨‹å‡æ”¾ç½®åœ¨ AQS çš„åŒå‘é“¾è¡¨ä¸Šï¼Œä½¿ç”¨ isShared æ–¹æ³•åŒºåˆ†
5. ReentrantReadWriteLock çš„ Sync ç±»ä½¿ç”¨ AQS çš„ state çš„é«˜ 16 ä½è®°å½•è·å–è¯»é”çš„çº¿ç¨‹æ•°ï¼Œä½¿ç”¨ä½ 16 ä½è®°å½•è·å–å†™é”çš„çº¿ç¨‹æ•°ï¼ˆå¯èƒ½ä¼šæœ‰é‡å…¥ï¼‰ï¼ŒtryAcquire å’Œ tryAcquireShared æ–¹æ³•é€šè¿‡è·å–é«˜ä½ä½ä»£è¡¨çš„ short å€¼æ¥åˆ¤æ–­æ˜¯å¦èƒ½ç›´æ¥æ‰§è¡Œï¼Œè¿˜æ˜¯éœ€è¦æŒ‚èµ·
6. ç”±äºè¯»é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è·å–ï¼Œæ¯ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹éƒ½èƒ½é‡å…¥ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªè®°å½•çº¿ç¨‹è¯»é”é‡å…¥æ•°é‡çš„åœ°æ–¹ï¼ŒSync ç±»çš„ HoldCounter ç±»å°±æ˜¯ç”¨æ¥åšè¿™ä¸ªçš„ï¼Œç„¶åä½¿ç”¨ ThreadLocal æ¥åŒ…è£¹ HoldCounter
7. ä¸ºäº†ä¼˜åŒ–è¯»é”é‡Šæ”¾ï¼ŒSync æœ‰ä¸€ä¸ª cachedHoldCounter å˜é‡ï¼Œç”¨æ¥è®°å½•æœ€åä¸€æ¬¡è·å– readLock çš„ HoldCounter çš„ç¼“å­˜ï¼Œå› ä¸ºå¾ˆå¤šåœºæ™¯ä¸‹ï¼Œè¿™æ¬¡è¿›è¡Œrelease readLock çš„çº¿ç¨‹å°±æ˜¯ä¸Šæ¬¡ acquire çš„çº¿ç¨‹, è¿™æ ·ç›´æ¥é€šè¿‡cachedHoldCounter æ¥è¿›è¡Œè·å–, èŠ‚çœäº†é€šè¿‡ readHolds çš„ lookup çš„è¿‡ç¨‹
8. firstReader å’Œ firstReaderHoldCount ç”¨æ¥è®°å½•ç¬¬ä¸€æ¬¡è·å–è¯»é”çš„çº¿ç¨‹ä»¥åŠé‡å…¥æ•°é‡ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¼˜åŒ–ï¼Œå‡†ç¡®çš„è¯´æ˜¯ç¬¬ä¸€æ¬¡è·å– readLock å¹¶ä¸” æ²¡æœ‰ release çš„çº¿ç¨‹, ä¸€æ—¦çº¿ç¨‹è¿›è¡Œ release readLock, åˆ™ firstReader ä¼šè¢«ç½®ä½ null
9. ThreadLocal ä¸­ä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œå› æ­¤å¦‚æœ HoldCounter.count ä¸º 0 çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨ remove é¿å…å†…å­˜æ³„æ¼ 